<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<div class="container mt-4">
  <h2>🔧 Hesap Ayarları</h2>

  <!-- Kullanıcı Bilgileri -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">Kullanıcı Bilgileri</h5>
      <p><strong>Kullanıcı Adı:</strong> {{ user.username }}</p>
      <p><strong>E-posta:</strong> {{ user.email or '—' }}</p>
    </div>
  </div>

  <!-- Bilgileri Güncelle -->
  <form id="settingsForm" class="mt-4">
    <div class="mb-3">
      <label for="username" class="form-label">Yeni Kullanıcı Adı</label>
      <input type="text" class="form-control" name="username" id="username" required>
    </div>
    <div class="mb-3">
      <label for="email" class="form-label">Yeni E-posta</label>
      <input type="email" class="form-control" name="email" id="email" required>
    </div>
    <div class="mb-3">
      <label for="current_password" class="form-label">Mevcut Şifre</label>
      <input type="password" class="form-control" name="current_password" id="current_password" required>
    </div>
    <button type="submit" class="btn btn-primary">Kaydet</button>
  </form>

  <div id="feedback" class="mt-3"></div>

  <script>
  // SADECE kullanıcı bilgilerini günceller
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('settingsForm');
    if (!form) return;
    const feedbackDiv = document.getElementById('feedback');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(form);

      const response = await fetch('/dashboard/update_settings', {
        method: 'POST',
        body: formData
      });

      try {
        const result = await response.json();
        feedbackDiv.innerHTML = `
          <div class="alert ${result.success ? 'alert-success' : 'alert-danger'}" role="alert">
            ${result.message}
          </div>
        `;
        if (result.success) setTimeout(() => location.reload(), 1500);
      } catch (error) {
        feedbackDiv.innerHTML = `
          <div class="alert alert-danger" role="alert">
            Sunucu hatası oluştu.
          </div>
        `;
      }
    });
  });
  </script>

  <hr class="my-4">

  <div>
    <h5>Şifre Değiştir</h5>
    <a href="{{ url_for('auth.change_password_form') }}" class="btn btn-outline-secondary">Şifre Değiştir</a>
  </div>

  <hr class="my-4">

  <!-- Hesabı Sil -->
  <div>
    <h5>Hesabı Kapat</h5>
    <form method="POST" action="{{ url_for('auth.delete_account') }}" id="deleteAccountForm" class="mt-2">
      <div class="mb-3">
        <label for="current_password_delete" class="form-label">Mevcut Şifre</label>
        <input type="password" class="form-control" name="password" id="current_password_delete" required>
      </div>
      <button type="submit" class="btn btn-danger">Hesabımı Sil</button>
    </form>
  </div>

  <script>
  // SADECE hesap silme formunu kontrol eder
  document.getElementById("deleteAccountForm").addEventListener("submit", function(event) {
    event.preventDefault(); // geçici durdur
    Swal.fire({
      title: "Emin misiniz?",
      text: "Bu işlem geri alınamaz!",
      icon: "warning",
      showCancelButton: true,
      confirmButtonText: "Evet, sil!",
      cancelButtonText: "Vazgeç"
    }).then((result) => {
      if (result.isConfirmed) {
        event.target.submit(); // formu gerçekten gönder
      }
    });
  });
  </script>
</div>
