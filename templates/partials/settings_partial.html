<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<div class="container mt-4">
  <h2>ğŸ”§ Hesap AyarlarÄ±</h2>

  <!-- KullanÄ±cÄ± Bilgileri -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">KullanÄ±cÄ± Bilgileri</h5>
      <p><strong>KullanÄ±cÄ± AdÄ±:</strong> {{ user.username }}</p>
      <p><strong>E-posta:</strong> {{ user.email or 'â€”' }}</p>
    </div>
  </div>

  <!-- Bilgileri GÃ¼ncelle -->
  <form id="settingsForm" class="mt-4">
    <div class="mb-3">
      <label for="username" class="form-label">Yeni KullanÄ±cÄ± AdÄ±</label>
      <input type="text" class="form-control" name="username" id="username" required>
    </div>
    <div class="mb-3">
      <label for="email" class="form-label">Yeni E-posta</label>
      <input type="email" class="form-control" name="email" id="email" required>
    </div>
    <div class="mb-3">
      <label for="current_password" class="form-label">Mevcut Åifre</label>
      <input type="password" class="form-control" name="current_password" id="current_password" required>
    </div>
    <button type="submit" class="btn btn-primary">Kaydet</button>
  </form>

  <div id="feedback" class="mt-3"></div>

  <script>
  // SADECE kullanÄ±cÄ± bilgilerini gÃ¼nceller
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('settingsForm');
    if (!form) return;
    const feedbackDiv = document.getElementById('feedback');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(form);

      const response = await fetch('/dashboard/update_settings', {
        method: 'POST',
        body: formData
      });

      try {
        const result = await response.json();
        feedbackDiv.innerHTML = `
          <div class="alert ${result.success ? 'alert-success' : 'alert-danger'}" role="alert">
            ${result.message}
          </div>
        `;
        if (result.success) setTimeout(() => location.reload(), 1500);
      } catch (error) {
        feedbackDiv.innerHTML = `
          <div class="alert alert-danger" role="alert">
            Sunucu hatasÄ± oluÅŸtu.
          </div>
        `;
      }
    });
  });
  </script>

  <hr class="my-4">

  <div>
    <h5>Åifre DeÄŸiÅŸtir</h5>
    <a href="{{ url_for('auth.change_password_form') }}" class="btn btn-outline-secondary">Åifre DeÄŸiÅŸtir</a>
  </div>

  <hr class="my-4">

  <!-- HesabÄ± Sil -->
  <div>
    <h5>HesabÄ± Kapat</h5>
    <form method="POST" action="{{ url_for('auth.delete_account') }}" id="deleteAccountForm" class="mt-2">
      <div class="mb-3">
        <label for="current_password_delete" class="form-label">Mevcut Åifre</label>
        <input type="password" class="form-control" name="password" id="current_password_delete" required>
      </div>
      <button type="submit" class="btn btn-danger">HesabÄ±mÄ± Sil</button>
    </form>
  </div>

  <script>
  // SADECE hesap silme formunu kontrol eder
  document.getElementById("deleteAccountForm").addEventListener("submit", function(event) {
    event.preventDefault(); // geÃ§ici durdur
    Swal.fire({
      title: "Emin misiniz?",
      text: "Bu iÅŸlem geri alÄ±namaz!",
      icon: "warning",
      showCancelButton: true,
      confirmButtonText: "Evet, sil!",
      cancelButtonText: "VazgeÃ§"
    }).then((result) => {
      if (result.isConfirmed) {
        event.target.submit(); // formu gerÃ§ekten gÃ¶nder
      }
    });
  });
  </script>
</div>
