// static/js/app.js (T√ºm Form ve Butonlarƒ± Destekleyen Son S√ºr√ºm)
document.addEventListener("DOMContentLoaded", function () {
    // --- TEMA DEƒûƒ∞≈ûTƒ∞RME MANTIƒûI ---
    const themeSwitcherButtons = document.querySelectorAll('[data-theme-value]');
    const htmlElement = document.documentElement;

    // Kaydedilmi≈ü temayƒ± uygula
    const savedTheme = localStorage.getItem('theme') || 'light';
    htmlElement.setAttribute('data-theme', savedTheme);

    // Aktif butonu i≈üaretle
    document.querySelector(`[data-theme-value="${savedTheme}"]`)?.classList.add('active');

    themeSwitcherButtons.forEach(button => {
        button.addEventListener('click', () => {
            const theme = button.getAttribute('data-theme-value');
            htmlElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);

            // T√ºm butonlardan 'active' sƒ±nƒ±fƒ±nƒ± kaldƒ±r ve sadece tƒ±klanana ekle
            // D√úZELTME: 'btn-light' ve 'btn-dark' yerine 'active' sƒ±nƒ±fƒ±nƒ± y√∂net
            themeSwitcherButtons.forEach(btn => {
                btn.classList.remove('active');
            });
            button.classList.add('active');
        });
    });

    const toggleBtn = document.getElementById("toggleSidebar");
    const sidebar = document.getElementById("sidebar");
    const main = document.querySelector(".main");
    const contentArea = document.getElementById("mainContent");
    const searchContainer = document.getElementById('search-container');

    let currentView = "home";
    
    // YENƒ∞: Etiketler i√ßin global dizi
    let selectedTags = [];

    // --- GENEL YARDIMCI FONKSƒ∞YONLAR ---

    function setActiveLink(linkId) {
        document.querySelectorAll(".nav-link").forEach(link => link.classList.remove("active"));
        const activeLink = document.getElementById(linkId);
        if (activeLink) activeLink.classList.add("active");
    }

    function showToast(message, type = "primary") {
        const toastEl = document.getElementById("toast");
        const toastBody = document.getElementById("toast-body");
        if (!toastEl || !toastBody) {
            alert(message);
            return;
        }
        toastBody.textContent = message;
        toastEl.className = `toast align-items-center text-bg-${type} border-0`;
        const bsToast = bootstrap.Toast.getOrCreateInstance(toastEl);
        bsToast.show();
    }

    // YENƒ∞: Rozet kazanma bildirimi (hem toast hem de b√ºy√ºk modal/konfeti)
    function showBadgeToast(badge) {
        console.log("Attempting to show badge notification for:", badge.name); // Debugging line

        // 1. Konfeti animasyonu
        confetti({
            particleCount: 150,
            spread: 180,
            origin: { y: 0.6 }, // Ekranƒ±n ortasƒ±ndan yukarƒ± doƒüru
            scalar: 1.2,
            startVelocity: 40,
            ticks: 300
        });

        // 2. B√ºy√ºk rozet kazanma modalƒ±nƒ± g√∂ster
        const badgeModalEl = document.getElementById('badgeEarnedModal');
        if (badgeModalEl) {
            const badgeModal = new bootstrap.Modal(badgeModalEl);
            document.getElementById('badgeModalIcon').className = `bi ${badge.icon}`;
            document.getElementById('badgeModalName').textContent = badge.name;
            document.getElementById('badgeModalDescription').textContent = badge.description;
            badgeModal.show();
        }

        // 3. Saƒü altta k√º√ß√ºk toast bildirimi
        const toastBody = `üèÜ Yeni Rozet Kazandƒ±n: **${badge.name}**!`;
        showToast(toastBody, "success");
    }

    // --- ARAMA FONKSƒ∞YONLARI ---

    // Arama √ßubuƒüunu g√∂ster/gizle
    function toggleSearchbar(show) {
        if (show) {
            searchContainer.classList.remove('d-none');
        } else {
            searchContainer.classList.add('d-none');
        }
    }

    // Arama filtreleme mantƒ±ƒüƒ±
    function filterContent() {
        const searchTerm = document.getElementById('search-input').value.toLowerCase();
        
        // Notlarƒ± filtrele
        if (currentView.includes('note')) {
            const notes = document.querySelectorAll('.note-card');
            notes.forEach(note => {
                const title = note.querySelector('h5').textContent.toLowerCase();
                const content = note.querySelector('.note-preview-text').textContent.toLowerCase();
                if (title.includes(searchTerm) || content.includes(searchTerm)) {
                    note.style.display = '';
                } else {
                    note.style.display = 'none';
                }
            });
        }
        // G√∂revleri filtrele
        else if (currentView.includes('task')) {
            const tasks = document.querySelectorAll('.task-item');
            tasks.forEach(task => {
                const title = task.querySelector('h5').textContent.toLowerCase();
                // G√∂revlerde sadece ba≈ülƒ±ƒüa g√∂re arama yapƒ±yoruz.
                if (title.includes(searchTerm)) {
                    task.style.display = 'flex'; // flex, √ß√ºnk√º task-item'lar display:flex kullanƒ±yor
                } else {
                    task.style.display = 'none';
                }
            });
        }
    }

    
    function toDateTimeLocalValue(dateStr) {
        if (!dateStr) return "";
        return dateStr.replace(" ", "T").slice(0, 16);
    }
    
    // --- S√úR√úKLE-BIRAK FONKSƒ∞YONU ---
    function initializeSortable() {
        // Sadece bekleyen g√∂revlerin olduƒüu listeyi s√ºr√ºkle-bƒ±rak i√ßin se√ß
        const taskListEl = document.querySelector('.task-list:not(.completed-list)');
        if (taskListEl && typeof Sortable !== 'undefined') {
            new Sortable(taskListEl, {
                animation: 150,
                handle: '.task-item', // T√ºm g√∂rev √∂ƒüesini s√ºr√ºkle
                onEnd: async function (evt) {
                    const items = evt.to.children;
                    const task_ids = Array.from(items).map(item => item.dataset.id);

                    // Sunucuya yeni sƒ±ralamayƒ± g√∂nder
                    try {
                        const response = await fetch('/dashboard/update_task_order', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ task_ids: task_ids }),
                        });
                        const result = await response.json();
                        if (!result.success) {
                            showToast('Sƒ±ralama kaydedilemedi.', 'danger');
                        }
                    } catch (error) {
                        showToast('Sunucu baƒülantƒ± hatasƒ±.', 'danger');
                    }
                }
            });
        }
    }

    // Sidebar toggle
    if (toggleBtn && sidebar) {
        toggleBtn.addEventListener("click", () => {
            sidebar.classList.toggle("collapsed");
            main.classList.toggle("collapsed");
        });
    }

    // --- HTML OLU≈ûTURUCULAR ---

    // 1. Notlar Istatistik G√∂r√ºn√ºm√º
    function createNotesGridHtml(notes) {
        let html = `
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3>${currentView === 'starred_notes' ? '‚≠ê Yƒ±ldƒ±zlƒ± Notlar' : 'T√ºm Notlar'}</h3>
                <div class="d-flex gap-2">
                    <button class="btn btn-primary btn-sm" id="btn-add-note">
                        <i class="bi bi-plus-lg me-1"></i> Yeni Not
                    </button>
                    ${notes.length > 0 ? `
                        <button class="btn btn-danger btn-sm" id="btn-delete-all-notes">
                            <i class="bi bi-trash-fill me-1"></i> Hepsini Sil
                        </button>
                    ` : ''}
                </div>
            </div>
            ${notes.length === 0 ? '<div class="alert alert-info">Hen√ºz not yok.</div>' : ''}
        `;

        if (notes.length > 0) {
            html += '<div class="cards-grid">';
            notes.forEach(note => {
                const isStarred = note.starred;
                const noteContent = encodeURIComponent(note.content || ''); 
                
                // Etiketleri olu≈ütur
                let tagsHtml = '';
                if (note.tags && note.tags.length > 0) {
                    tagsHtml = `<div class="note-tags">${note.tags.map(tag => `<span class="badge bg-secondary">${tag}</span>`).join(' ')}</div>`;
                }

                html += `
                    <div class="note-card shadow-sm" data-id="${note.id}">
                        <div class="note-card-header">
                            <h5>${note.title}</h5>
                            <div class="note-actions">
                                <button class="btn-task-action toggle-star" data-id="${note.id}" title="Yƒ±ldƒ±zla">
                                    <i class="bi ${isStarred ? 'bi-star-fill star-fill' : 'bi-star'}"></i>
                                </button>
                            </div>
                        </div>
                        <div class="note-preview-text">${note.content.replace(/<[^>]*>?/gm, '')}</div>
                        ${tagsHtml}
                        
                        <div class="note-footer d-flex justify-content-between align-items-center">
                             <button class="btn btn-outline-secondary btn-sm edit-note" data-id="${note.id}" 
                                     onclick="loadEditNoteForm(${note.id}, '${encodeURIComponent(note.title)}', '${noteContent}', '${encodeURIComponent(note.tags.join(', '))}')" title="D√ºzenle">
                                <i class="bi bi-pencil"></i> D√ºzenle
                            </button>
                            <small class="text-muted">G√ºncellendi: ${new Date(note.last_updated).toLocaleDateString()}</small>
                             <button class="btn-task-action delete-note delete" data-id="${note.id}" title="Sil">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
        }
        return html;
    }

    // 2. G√∂revler Liste G√∂r√ºn√ºm√º
    function createTasksListHtml(tasks, title, isCompletedView = false) {
        const waitingTasks = tasks.filter(t => !t.completed);
        const completedTasks = tasks.filter(t => t.completed);

        let html = `
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3>${title}</h3>
                <div class="d-flex gap-2">
                ${!isCompletedView && currentView !== 'upcoming_tasks' && currentView !== 'starred_tasks' && !currentView.startsWith('tag_') ? `
                    <button class="btn btn-primary btn-sm" id="btn-add-task">
                        <i class="bi bi-plus-lg me-1"></i> Yeni G√∂rev
                    </button>
                ` : ''}
                ${currentView === 'all_tasks' && (waitingTasks.length > 0 || completedTasks.length > 0) ? `
                    <button class="btn btn-danger btn-sm" id="btn-delete-all-tasks">
                        <i class="bi bi-trash-fill me-1"></i> Hepsini Sil
                    </button>
                ` : ''}
                </div>
            </div>
        `;
        
        // D√úZELTME: Eƒüer hi√ß g√∂rev yoksa, tek bir "bo≈ü durum" mesajƒ± g√∂ster
        if (tasks.length === 0 && currentView === 'all_tasks') {
            html += `<div class="alert alert-info mt-4">Hen√ºz hi√ß g√∂reviniz yok. "Yeni G√∂rev" butonuna tƒ±klayarak ba≈ülayabilirsiniz.</div>`;
        } else {
            // Bekleyen G√∂revler
            if (waitingTasks.length > 0 && !isCompletedView) {
                html += `<h4 class="mb-3 text-muted">Bekleyenler (${waitingTasks.length})</h4><ul class="task-list" id="waiting-tasks-list">`;
                waitingTasks.forEach(task => { html += createTaskItemHtml(task); });
                html += `</ul>`;
            }
            // Tamamlanan G√∂revler
            if (completedTasks.length > 0 || isCompletedView) {
                html += `<h4 class="${!isCompletedView ? 'mt-4' : ''} mb-3 text-muted">Tamamlananlar (${completedTasks.length})</h4><ul class="task-list completed-list">`;
                completedTasks.forEach(task => { html += createTaskItemHtml(task); });
                html += `</ul>`;
            }
        }

        // HTML i√ßeriƒüi DOM'a eklendikten sonra s√ºr√ºkle-bƒ±rak √∂zelliƒüini ba≈ülat
        setTimeout(initializeSortable, 0);

        return html;
    }

    function createTaskItemHtml(task) {
        const completedClass = task.completed ? 'completed' : '';
        const due_date = task.due_date ? new Date(task.due_date).toLocaleDateString() + " " + new Date(task.due_date).toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' }) : "Tarih Belirtilmedi";
        
        let actions = '';
        if (task.completed) {
            actions = `
                <button class="btn-task-action toggle-complete" data-id="${task.id}" title="Geri Al"><i class="bi bi-arrow-counterclockwise"></i></button>
                <button class="btn-task-action delete-task delete" data-id="${task.id}" title="Sil"><i class="bi bi-trash"></i></button>
            `;
        } else {
            actions = `
                <button class="btn-task-action toggle-star-task" data-id="${task.id}" title="Yƒ±ldƒ±zla">
                    <i class="bi ${task.starred ? 'bi-star-fill star-fill' : 'bi-star'}"></i>
                </button>
                <button class="btn-task-action edit-task" data-id="${task.id}" title="D√ºzenle"><i class="bi bi-pencil"></i></button>
                <button class="btn-task-action delete-task delete" data-id="${task.id}" title="Sil"><i class="bi bi-trash"></i></button>
                <button class="btn-task-action toggle-complete" data-id="${task.id}" title="Tamamla"><i class="bi bi-check-lg"></i></button>
            `;
        }

        return `
            <li class="task-item ${completedClass}" data-id="${task.id}" style="cursor: grab;">
                <div class="task-content">
                    <input type="checkbox" class="task-checkbox toggle-complete" data-id="${task.id}" ${task.completed ? 'checked' : ''} title="Durumu Deƒüi≈ütir">
                    <div class="task-text-group">
                        <h5>${task.title}</h5>
                        <small>${due_date}</small>
                    </div>
                </div>
                <div class="task-actions">
                    ${actions}
                </div>
                ${task.tags && task.tags.length > 0 ? `
                    <div class="task-tags mt-2">
                        ${task.tags.map(tag => `<span class="badge bg-secondary me-1">${tag}</span>`).join('')}
                    </div>
                ` : ''}
            </li>
        `;
    }

    // YENƒ∞ FONKSƒ∞YON: Etiketlenmi≈ü i√ßerik g√∂r√ºn√ºm√º
    function createTagItemsHtml(data, tagName) {
        let html = `
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3>Etiket: <span class="badge bg-primary fs-5">#${tagName}</span></h3>
            </div>
        `;

        // Notlar b√∂l√ºm√º
        if (data.notes.length > 0) {
            html += `<h4 class="mb-3 text-muted">Bu Etikete Sahip Notlar (${data.notes.length})</h4>`;
            html += '<div class="cards-grid">';
            data.notes.forEach(note => {
                // createNotesGridHtml i√ßindeki mantƒ±ƒüƒ± burada yeniden kullanƒ±yoruz
                const isStarred = note.starred;
                const noteContent = encodeURIComponent(note.content || '');
                let tagsHtml = `<div class="note-tags">${note.tags.map(tag => `<span class="badge bg-secondary">${tag}</span>`).join(' ')}</div>`;

                html += `
                    <div class="note-card shadow-sm" data-id="${note.id}">
                        <div class="note-card-header">
                            <h5>${note.title}</h5>
                            <div class="note-actions">
                                <button class="btn-task-action toggle-star" data-id="${note.id}" title="Yƒ±ldƒ±zla">
                                    <i class="bi ${isStarred ? 'bi-star-fill star-fill' : 'bi-star'}"></i>
                                </button>
                            </div>
                        </div>
                        <div class="note-preview-text">${note.content.replace(/<[^>]*>?/gm, '')}</div>
                        ${tagsHtml}
                        <div class="note-footer d-flex justify-content-between align-items-center">
                             <button class="btn btn-outline-secondary btn-sm edit-note" data-id="${note.id}" 
                                     onclick="loadEditNoteForm(${note.id}, '${encodeURIComponent(note.title)}', '${noteContent}', '${encodeURIComponent(note.tags.join(', '))}')" title="D√ºzenle">
                                <i class="bi bi-pencil"></i> D√ºzenle
                            </button>
                            <small class="text-muted">G√ºncellendi: ${new Date(note.last_updated).toLocaleDateString()}</small>
                             <button class="btn-task-action delete-note delete" data-id="${note.id}" title="Sil">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>`;
            });
            html += '</div>';
        }

        // G√∂revler b√∂l√ºm√º
        if (data.tasks.length > 0) {
            html += `<h4 class="mt-4 mb-3 text-muted">Bu Etikete Sahip G√∂revler (${data.tasks.length})</h4>`;
            // createTasksListHtml fonksiyonunu yeniden kullanmak yerine direkt listeyi olu≈üturuyoruz
            html += createTasksListHtml(data.tasks, '', false);
        }
        return html;
    }

    // --- FORM Y√úKLEYƒ∞Cƒ∞LER ---

    // Not Ekleme Formu
    function loadAddNoteForm() {
        currentView = "add_note";
        toggleSearchbar(false); // Arama √ßubuƒüunu gizle
        
        // CSRF token'ƒ± al
        const csrfToken = document.querySelector('[name=csrf_token]')?.value || '';
        
        contentArea.innerHTML = `
            <div class="form-card shadow-lg">
                <h3 class="text-center mb-4">Yeni Not Ekle</h3>
                <form id="addNoteForm" class="needs-validation" novalidate>
                    <input type="hidden" name="csrf_token" value="${csrfToken}">
                    <div class="mb-3">
                        <label for="title" class="form-label">Ba≈ülƒ±k</label>
                        <input type="text" class="form-control" id="title" name="title" 
                               placeholder="Not Ba≈ülƒ±ƒüƒ±" required
                               minlength="2" maxlength="200">
                        <div class="invalid-feedback">L√ºtfen bir ba≈ülƒ±k girin (en az 2 karakter)</div>
                    </div>
                    <div class="mb-3">
                        <label for="content" class="form-label">ƒ∞√ßerik</label>
                        <textarea class="form-control" id="content" name="content" 
                                  rows="6" placeholder="Notun i√ßeriƒüini buraya girin..." 
                                  required minlength="5">
                        </textarea>
                        <div class="invalid-feedback">Not i√ßeriƒüi en az 5 karakter olmalƒ±dƒ±r</div>
                    </div>
                    <div class="mb-3">
                        <label for="tags" class="form-label">Etiketler</label>
                        <div class="selected-tags mb-2"></div>
                        <div class="input-group">
                            <input type="text" class="form-control" id="tagInput" 
                                   placeholder="Etiket eklemek i√ßin yazƒ±n ve Enter'a basƒ±n">
                            <button class="btn btn-outline-secondary" type="button" id="addTagButton">
                                <i class="bi bi-plus-lg"></i> Ekle
                            </button>
                        </div>
                        <small class="form-text text-muted">Her etiket i√ßin Enter'a basƒ±n veya Ekle butonuna tƒ±klayƒ±n</small>
                    </div>
                    <div class="d-flex justify-content-between align-items-center gap-2 mt-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="starred" name="starred">
                            <label class="form-check-label" for="starred">
                                <i class="bi bi-star-fill text-warning"></i> Yƒ±ldƒ±zlƒ±
                            </label>
                        </div>
                        <div>
                            <button class="btn btn-secondary" type="button" onclick="loadAllNotes()">
                                <i class="bi bi-x-lg"></i> ƒ∞ptal
                            </button>
                            <button class="btn btn-primary" type="submit">
                                <i class="bi bi-check-lg"></i> Kaydet
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        `;

        // YENƒ∞: Etiket ekleme mantƒ±ƒüƒ±nƒ± burada baƒülƒ±yoruz
        const tagInput = document.getElementById('tagInput');
        const addTagButton = document.getElementById('addTagButton');
        const selectedTagsContainer = document.querySelector('.selected-tags');

        function addTag(tag) {
            tag = tag.trim().toLowerCase();
            if (tag && !selectedTags.includes(tag)) {
                selectedTags.push(tag);
                updateSelectedTagsDisplay();
            }
            tagInput.value = '';
        }

        function updateSelectedTagsDisplay() {
            selectedTagsContainer.innerHTML = '';
            selectedTags.forEach((tag, index) => {
                const tagEl = document.createElement('span');
                tagEl.className = 'badge bg-primary me-2 mb-2';
                tagEl.innerHTML = `
                    ${tag}
                    <button type="button" class="btn-close btn-close-white ms-1" 
                            aria-label="Close" data-index="${index}" 
                            style="font-size: 0.6em;"></button>
                `;
                selectedTagsContainer.appendChild(tagEl);
            });
        }

        // Etiket silme
        selectedTagsContainer.addEventListener('click', function(e) {
            if (e.target.matches('.btn-close')) {
                const index = parseInt(e.target.dataset.index, 10);
                selectedTags.splice(index, 1);
                updateSelectedTagsDisplay();
            }
        });

        // Butonla etiket ekleme
        addTagButton.addEventListener('click', function() {
            addTag(tagInput.value);
        });

        // Enter ile etiket ekleme
        tagInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                addTag(tagInput.value);
            }
        });

        updateSelectedTagsDisplay(); // Ba≈ülangƒ±√ßta bo≈ü haliyle g√∂ster
    }

    function destroyTinyMCE() {
        // TinyMCE kaldƒ±rƒ±ldƒ±ƒüƒ± i√ßin bu fonksiyon artƒ±k bo≈ü.
    }

    // Not D√ºzenleme Formu
window.loadEditNoteForm = function(noteId, title, content, tags) {
    currentView = "edit_note";
    toggleSearchbar(false); // Arama √ßubuƒüunu gizle
    const safeTitle = decodeURIComponent(title);
    const safeContent = decodeURIComponent(content);
    const tagsString = decodeURIComponent(tags || '');
    
    // HTML i√ßeriƒüi, not verileriyle doldurulur
    contentArea.innerHTML = `
        <div class="form-card shadow-lg">
            <h3 class="text-center">Notu D√ºzenle</h3>
            <form id="editNoteForm" data-id="${noteId}">
                <div class="mb-3">
                    <label for="title" class="form-label">Ba≈ülƒ±k</label>
                    <input class="form-control" id="title" name="title" value="${safeTitle}" required>
                </div>
                <div class="mb-3">
                    <label for="content" class="form-label">ƒ∞√ßerik</label>
                    <textarea class="form-control" id="content" name="content" rows="6" required>${safeContent}</textarea>
                </div>
                <div class="mb-3">
                    <label for="tags" class="form-label">Etiketler (virg√ºlle ayƒ±rƒ±n)</label>
                    <input type="text" class="form-control" id="tags" name="tags" value="${tagsString}" placeholder="i≈ü, ki≈üisel, √∂nemli">
                </div>
                <div class="d-flex justify-content-end gap-2 mt-4">
                    <button class="btn btn-primary" type="submit">G√ºncelle</button>
                    <button class="btn btn-secondary" type="button" onclick="loadAllNotes()">ƒ∞ptal</button>
                </div>
            </form>
        </div>
    `;
};
    // G√∂rev Ekleme Formunu y√ºkler
    function loadAddTaskForm() {
         currentView = "add_task";
         selectedTags = []; // Her form a√ßƒ±ldƒ±ƒüƒ±nda etiketleri sƒ±fƒ±rla
         toggleSearchbar(false); // Arama √ßubuƒüunu gizle
         contentArea.innerHTML = `
            <div class="form-card shadow-lg">
                <h3 class="text-center">Yeni G√∂rev Ekle</h3>
                <form id="addTaskForm">
                    <div class="mb-3">
                        <label for="title" class="form-label">Ba≈ülƒ±k</label>
                        <input type="text" class="form-control" id="title" name="title" placeholder="G√∂revin ba≈ülƒ±ƒüƒ±" required minlength="2" maxlength="200">
                        <div class="invalid-feedback">L√ºtfen bir ba≈ülƒ±k girin (en az 2 karakter).</div>
                    </div>
                    <div class="mb-3">
                        <label for="content" class="form-label">A√ßƒ±klama (ƒ∞steƒüe Baƒülƒ±)</label>
                        <textarea class="form-control" id="content" name="content" rows="4" placeholder="G√∂revle ilgili detaylar..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="due_date" class="form-label">Biti≈ü Zamanƒ±</label>
                        <input type="datetime-local" class="form-control" name="due_date">
                    </div>
                    <div class="mb-3">
                        <label for="tags" class="form-label">Etiketler</label>
                        <div class="selected-tags mb-2"></div>
                        <div class="input-group">
                            <input type="text" class="form-control" id="tagInput" placeholder="Etiket eklemek i√ßin yazƒ±n ve Enter'a basƒ±n">
                            <button class="btn btn-outline-secondary" type="button" id="addTagButton"><i class="bi bi-plus-lg"></i> Ekle</button>
                        </div>
                        <small class="form-text text-muted">Her etiket i√ßin Enter'a basƒ±n veya Ekle butonuna tƒ±klayƒ±n.</small>
                    </div>
                    <div class="d-flex justify-content-between align-items-center gap-2 mt-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="starred" name="starred">
                            <label class="form-check-label" for="starred">
                                <i class="bi bi-star-fill text-warning"></i> Yƒ±ldƒ±zlƒ±
                            </label>
                        </div>
                        <div>
                            <button class="btn btn-secondary" type="button" id="btn-cancel-edit-task"><i class="bi bi-x-lg"></i> ƒ∞ptal</button>
                            <button class="btn btn-primary" type="submit"><i class="bi bi-check-lg"></i> Kaydet</button>
                        </div>
                    </div>
                </form>
            </div>
        `;

        // Etiket ekleme mantƒ±ƒüƒ±nƒ± buraya da ekliyoruz
        const tagInput = document.getElementById('tagInput');
        const addTagButton = document.getElementById('addTagButton');
        const selectedTagsContainer = document.querySelector('.selected-tags');

        function addTag(tag) {
            tag = tag.trim().toLowerCase();
            if (tag && !selectedTags.includes(tag)) {
                selectedTags.push(tag);
                updateSelectedTagsDisplay();
            }
            tagInput.value = '';
        }

        function updateSelectedTagsDisplay() {
            selectedTagsContainer.innerHTML = '';
            selectedTags.forEach((tag, index) => {
                const tagEl = document.createElement('span');
                tagEl.className = 'badge bg-primary me-2 mb-2';
                tagEl.innerHTML = `${tag} <button type="button" class="btn-close btn-close-white ms-1" aria-label="Close" data-index="${index}" style="font-size: 0.6em;"></button>`;
                selectedTagsContainer.appendChild(tagEl);
            });
        }

        selectedTagsContainer.addEventListener('click', function(e) {
            if (e.target.matches('.btn-close')) {
                const index = parseInt(e.target.dataset.index, 10);
                selectedTags.splice(index, 1);
                updateSelectedTagsDisplay();
            }
        });

        addTagButton.addEventListener('click', () => addTag(tagInput.value));

        tagInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                addTag(tagInput.value);
            }
        });

        updateSelectedTagsDisplay();
    }

    // G√∂rev D√ºzenleme Formu
    window.loadEditTaskForm = function(taskId, title, content, due_date, tags) {
        currentView = "edit_task";
        toggleSearchbar(false); // Arama √ßubuƒüunu gizle
        const safeTitle = decodeURIComponent(title);
        const safeContent = decodeURIComponent(content);
        const datetimeVal = toDateTimeLocalValue(due_date || "");
        const tagsString = decodeURIComponent(tags || '');

        contentArea.innerHTML = `
            <div class="form-card shadow-lg">
                <h3 class="text-center">G√∂revi D√ºzenle</h3>
                <form id="editTaskForm" data-id="${taskId}">
                    <div class="mb-3">
                        <label for="title" class="form-label">Ba≈ülƒ±k</label>
                        <input type="text" class="form-control" name="title" value="${safeTitle}" required>
                    </div>
                    <div class="mb-3">
                        <label for="content" class="form-label">ƒ∞√ßerik</label>
                        <textarea class="form-control" name="content" rows="4">${safeContent}</textarea>
                    </div>
                    <div class="mb-3">
                        <label for="due_date" class="form-label">G√∂rev Zamanƒ±</label>
                        <input type="datetime-local" class="form-control" name="due_date" value="${datetimeVal}">
                    </div>
                    <div class="mb-3">
                        <label for="tags" class="form-label">Etiketler (virg√ºlle ayƒ±rƒ±n)</label>
                        <input type="text" class="form-control" id="tags" name="tags" value="${tagsString}" placeholder="proje, toplantƒ±, acil">
                    </div>
                    <div class="d-flex justify-content-end gap-2 mt-4">
                        <button class="btn btn-primary" type="submit"><i class="bi bi-check-lg"></i> G√ºncelle</button>
                        <button class="btn btn-secondary" type="button" id="btn-cancel-edit-task"><i class="bi bi-x-lg"></i> ƒ∞ptal</button>
                    </div>
                </form>
            </div>
        `;
    };

    // --- VERƒ∞ Y√úKLEYƒ∞Cƒ∞LER (Ana Navigasyon) ---

    async function loadAllNotes() {
        currentView = "all_notes";
        destroyTinyMCE(); // √ñnceki edit√∂r√º temizle
        setActiveLink('link-all-notes');
        const response = await fetch("/dashboard/get_notes");
        // Global 'notes' deƒüi≈ükenini g√ºncelle
        window.notes = await response.json();
        toggleSearchbar(notes.length > 0); // Not varsa arama √ßubuƒüunu g√∂ster
        contentArea.innerHTML = createNotesGridHtml(notes);
    }
    window.loadAllNotes = loadAllNotes;

    async function loadStarredNotes() {
        currentView = "starred_notes";
        destroyTinyMCE(); // √ñnceki edit√∂r√º temizle
        setActiveLink('link-starred-notes');
        const response = await fetch("/dashboard/get_notes");
        window.notes = await response.json();
        const starred = notes.filter(n => n.starred);
        toggleSearchbar(starred.length > 0);
        contentArea.innerHTML = createNotesGridHtml(starred);
    }

    async function loadAllTasks() {
        currentView = "all_tasks";
        destroyTinyMCE(); // √ñnceki edit√∂r√º temizle
        setActiveLink('link-all-tasks');
        const response = await fetch("/dashboard/all_tasks_data");
        // Global 'tasks' deƒüi≈ükenini g√ºncelle
        window.tasks = await response.json();
        contentArea.innerHTML = createTasksListHtml(window.tasks, 'T√ºm G√∂revlerim');
        toggleSearchbar(window.tasks.length > 0);
    }
    window.loadAllTasks = loadAllTasks;

    async function loadStarredTasks() {
        currentView = "starred_tasks";
        destroyTinyMCE(); // √ñnceki edit√∂r√º temizle
        setActiveLink('link-starred-tasks');
        const response = await fetch("/dashboard/all_tasks_data");
        window.tasks = await response.json();
        const starred = window.tasks.filter(t => t.starred && !t.completed);
        toggleSearchbar(starred.length > 0);
        
        if (starred.length === 0) {
            contentArea.innerHTML = `<h3>‚≠ê Yƒ±ldƒ±zlƒ± G√∂revler</h3><div class="alert alert-info mt-4">Hen√ºz yƒ±ldƒ±zlƒ± bir g√∂reviniz yok.</div>`;
        } else {
            contentArea.innerHTML = createTasksListHtml(starred, '‚≠ê Yƒ±ldƒ±zlƒ± G√∂revler', false);
        }
    }

    async function loadCompletedTasks() {
        currentView = "completed_tasks";
        destroyTinyMCE(); // √ñnceki edit√∂r√º temizle
        setActiveLink('link-completed-tasks');
        const response = await fetch("/dashboard/all_tasks_data");
        window.tasks = await response.json();
        const completed = window.tasks.filter(t => t.completed);
        toggleSearchbar(completed.length > 0);
        contentArea.innerHTML = createTasksListHtml(completed, 'Tamamlanan G√∂revler', true);
    }
    
    async function loadUpcomingTasks() {
        currentView = "upcoming_tasks";
        destroyTinyMCE(); // √ñnceki edit√∂r√º temizle
        setActiveLink('link-upcoming-tasks');
        const response = await fetch("/dashboard/upcoming_tasks");
        const tasks = await response.json();
        window.tasks = tasks; // Global tasks'ƒ± g√ºncelle
        toggleSearchbar(tasks.length > 0);
        let html = ``;
        if (tasks.length === 0) {
            html += `<h3>Zamanƒ± Yakla≈üan G√∂revler</h3><div class="alert alert-info mt-4">Yakƒ±n zamanda vadesi dolacak g√∂rev yok.</div>`;
        } else {
            html += createTasksListHtml(tasks, 'Zamanƒ± Yakla≈üan G√∂revler', false); // Liste olu≈üturucu kullanƒ±ldƒ±
        }
        contentArea.innerHTML = html;
    }

    async function loadOverdueTasks() {
        currentView = "overdue_tasks";
        destroyTinyMCE(); // √ñnceki edit√∂r√º temizle
        setActiveLink('link-overdue-tasks');
        const response = await fetch("/dashboard/overdue_tasks");
        const tasks = await response.json();
        window.tasks = tasks; // Global tasks'ƒ± g√ºncelle
        toggleSearchbar(tasks.length > 0);
        
        if (tasks.length === 0) {
            contentArea.innerHTML = `<h3>‚åõ Gecikmi≈ü G√∂revler</h3><div class="alert alert-info mt-4">Gecikmi≈ü g√∂reviniz bulunmuyor.</div>`;
        } else {
            const html = createTasksListHtml(tasks, '‚åõ Gecikmi≈ü G√∂revler', false);
            contentArea.innerHTML = html;
        }
    }

    // YENƒ∞: Etiketleri Sidebar'a y√ºkler
    async function loadTags() {
        const tagsContainer = document.getElementById('tags-list-container');
        if (!tagsContainer) return;

        const response = await fetch("/dashboard/get_tags");
        const tags = await response.json();

        tagsContainer.innerHTML = ''; // Konteyneri temizle
        if (tags.length === 0) {
            tagsContainer.innerHTML = '<span class="nav-link text-muted small">Hen√ºz etiket yok.</span>';
        } else {
            tags.forEach(tag => {
                const tagLink = document.createElement('a');
                tagLink.className = 'nav-item nav-link';
                tagLink.href = '#';
                tagLink.id = `link-tag-${tag.id}`;
                tagLink.dataset.tagId = tag.id;
                tagLink.innerHTML = `<i class="bi bi-hash"></i> <span class="sidebar-text">${tag.name}</span>`;
                tagsContainer.appendChild(tagLink);
            });
        }
    }



async function loadUserStats() {
    const statsArea = document.getElementById('user-stats-area');
    if (statsArea) {
        try {
            const response = await fetch('/dashboard/user_stats_html'); 
            if (response.ok) {
                const html = await response.text();
                statsArea.innerHTML = html;
            } else {
                statsArea.innerHTML = '<div class="text-center text-danger py-3"><i class="bi bi-x-circle me-1"></i> Veri y√ºklenemedi.</div>';
                console.error('ƒ∞statistik y√ºkleme hatasƒ±:', response.status, response.statusText);
            }
        } catch (error) {
            statsArea.innerHTML = '<div class="text-center text-danger py-3">Baƒülantƒ± hatasƒ±.</div>';
            console.error('AJAX hatasƒ±:', error);
        }
    }
}

    // Ayarlar Formunu y√ºkler
    async function loadSettingsForm() {
    currentView = "settings";
    setActiveLink('link-settings');
    toggleSearchbar(false); // Ayarlar sayfasƒ±nda arama √ßubuƒüunu gizle
    const contentArea = document.getElementById("mainContent");
    if (!contentArea) return; 

    // 1. Ayarlar sayfasƒ±nƒ±n i√ßeriƒüini sunucudan √ßek ve y√ºkle
    const response = await fetch("/dashboard/settings");
    const html = await response.text();
    contentArea.innerHTML = html;
    
    // 2. YENƒ∞: Y√ºklenen i√ßeriƒüin √ºzerindeki butonlarƒ± ve formlarƒ± dinle
    
    // a. ≈ûifre Deƒüi≈ütirme Butonu (link-change-password)
    const changePassBtn = document.getElementById('link-change-password');
    if (changePassBtn) {
        changePassBtn.addEventListener('click', loadChangePasswordForm);
    }

    // b. Hesap Silme Butonu (btn-show-delete-form)
    const deleteAccountBtn = document.getElementById('btn-show-delete-form');
    if (deleteAccountBtn) {
        deleteAccountBtn.addEventListener('click', loadDeleteAccountForm);
    }

    // c. Kullanƒ±cƒ± Bilgileri Kaydet Formu (settingsForm)
    const userSettingsForm = document.getElementById('settingsForm'); // Buraya ID'yi doƒüru aldƒ±k
    if (userSettingsForm) {
        userSettingsForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            const res = await fetch('/dashboard/update_settings', { method: 'POST', body: formData });
            const result = await res.json();
            
            showToast(result.message, result.success ? "success" : "danger");
            if (result.success) loadSettingsForm();
        });
    }
}

// Hesap Silme Onay Formunu y√ºkler (ƒ∞ptal Butonu Mantƒ±ƒüƒ±)
function loadDeleteAccountForm() {
    currentView = "delete_account";
    toggleSearchbar(false);
    const contentArea = document.getElementById("mainContent");
    if (!contentArea) return; 

    // ≈ûifre onay formunun HTML'i
    contentArea.innerHTML = `
        <div class="card p-4 shadow-lg mx-auto" style="max-width: 400px; margin-top: 50px;">
            <h3 class="text-center mb-4 text-danger">Hesabƒ±nƒ±zƒ± Kapatƒ±n</h3>
            <p class="text-muted text-center">Hesabƒ±nƒ±zƒ± kalƒ±cƒ± olarak kapatmak √ºzeresiniz. Bu i≈ülem geri alƒ±namaz.</p>
            <form id="deleteAccountFormWithPassword">
                <div class="mb-3">
                    <label for="delete_password" class="form-label">Onay ƒ∞√ßin ≈ûifrenizi Girin</label>
                    <input type="password" name="password" id="delete_password" class="form-control" required>
                </div>
                <div id="delete-feedback" class="mt-2 mb-3"></div>
                <div class="d-flex justify-content-end gap-2 mt-4">
                    <button class="btn btn-secondary" type="button" id="btn-cancel-delete">ƒ∞ptal</button> 
                    <button class="btn btn-danger" type="submit">Hesabƒ±mƒ± Kalƒ±cƒ± Sil</button>
                </div>
            </form>
        </div>
    `;
}
    
    // ≈ûifre Deƒüi≈ütirme Formunu y√ºkler
    function loadChangePasswordForm() {
        currentView = "change_password";
        toggleSearchbar(false);
        contentArea.innerHTML = `
            <div class="form-card shadow-lg">
                <h3 class="text-center mb-4">üîë ≈ûifre Deƒüi≈ütir</h3>
                <form id="changePasswordForm">
                    <div class="mb-3">
                        <label for="current_password" class="form-label">Mevcut ≈ûifre</label>
                        <input type="password" name="current_password" id="current_password" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="new_password" class="form-label">Yeni ≈ûifre</label>
                        <input type="password" name="new_password" id="new_password" class="form-control" required>
                    </div>
                    <div class="mb-4">
                        <label for="confirm_password" class="form-label">Yeni ≈ûifre (Tekrar)</label>
                        <input type="password" name="confirm_password" id="confirm_password" class="form-control" required>
                    </div>
                    <div id="password-feedback"></div>
                    <div class="d-flex justify-content-end gap-2 mt-4">
                        <button class="btn btn-primary" type="submit">≈ûifreyi G√ºncelle</button>
                        <button class="btn btn-secondary" type="button" onclick="loadSettingsForm()">ƒ∞ptal</button>
                    </div>
                </form>
            </div>
        `;
        const cancelBtn = document.getElementById('btn-cancel-change-password');
    if (cancelBtn) {
        cancelBtn.addEventListener('click', function() {
            window.loadSettingsForm();
        });
    }
    window.loadSettingsForm = loadSettingsForm;
    }

    // YENƒ∞: Rozetler sayfasƒ±nƒ± y√ºkler
    async function loadBadgesPage() {
        currentView = "badges";
        setActiveLink('link-badges'); // Men√ºde aktif linki ayarlar
        toggleSearchbar(false);
        const contentArea = document.getElementById("mainContent");
        if (!contentArea) return;

        const response = await fetch("/dashboard/badges");
        const html = await response.text();
        contentArea.innerHTML = html;
        showAssistantMessage("Kazandƒ±ƒüƒ±n ve kazanabileceƒüin t√ºm rozetleri buradan g√∂rebilirsin. Ba≈üarƒ±larƒ±nƒ±n devamƒ±nƒ± dilerim!");
    }

    // YENƒ∞: Avatarlar sayfasƒ±nƒ± y√ºkler
    async function loadAvatarsPage() {
        currentView = "avatars";
        setActiveLink('link-avatars');
        toggleSearchbar(false);
        const contentArea = document.getElementById("mainContent");
        if (!contentArea) return;

        const response = await fetch("/dashboard/avatars");
        const html = await response.text();
        contentArea.innerHTML = html;
        showAssistantMessage("Profilini ki≈üiselle≈ütirmek i√ßin buradan bir avatar se√ßebilirsin.");

        // Avatar se√ßimi i√ßin olay dinleyicisini buraya ta≈üƒ±dƒ±k
        const avatarGrid = document.getElementById('avatar-selection-grid');
        if (avatarGrid) {
            avatarGrid.addEventListener('click', async function(e) {
                const avatarDiv = e.target.closest('.avatar-option');
                if (!avatarDiv) return;

                // √ñnceki se√ßimi kaldƒ±r, yenisini ekle
                document.querySelectorAll('.avatar-option.selected').forEach(el => el.classList.remove('selected'));
                avatarDiv.classList.add('selected');

                const avatarFilename = avatarDiv.dataset.filename;
                const formData = new FormData();
                formData.append('avatar', avatarFilename);

                const res = await fetch('/dashboard/update_avatar', { method: 'POST', body: formData });
                const result = await res.json();

                showToast(result.message, result.success ? "success" : "danger");
                if (result.success) {
                    // D√úZELTME: Avatarƒ± anƒ±nda g√ºncellemek i√ßin HTML'i yeniden olu≈ütur
                    const newAvatarHtml = `<img src="${result.new_avatar_url}" alt="Avatar" class="rounded-circle w-100 h-100" style="object-fit: cover;">`;
                    
                    // √úst √ßubuktaki avatarƒ± g√ºncelle
                    const topbarAvatarContainer = document.getElementById('user-avatar-container');
                    if (topbarAvatarContainer) topbarAvatarContainer.innerHTML = newAvatarHtml;

                    // A√ßƒ±lƒ±r men√ºdeki avatarƒ± g√ºncelle
                    const dropdownAvatarContainer = document.querySelector('.dropdown-menu .user-icon');
                    if (dropdownAvatarContainer) dropdownAvatarContainer.innerHTML = newAvatarHtml;
                }
            });
        }
    }

    // --- TIKLAMA VE FORM G√ñNDERƒ∞M ƒ∞≈ûLEMLERƒ∞ (Delegasyon) ---

    // 1. Sidebar Navigasyonu
    document.querySelectorAll("#main-nav .nav-link").forEach(link => {
        link.addEventListener("click", function (e) {
            e.preventDefault();
            const linkId = this.id;
            
            setActiveLink(linkId);

            if (linkId === 'link-all-notes') {
                loadAllNotes();
                showAssistantMessage("T√ºm notlarƒ±nƒ± burada g√∂rebilirsin. Kartlara tƒ±klayarak detaylarƒ± d√ºzenleyebilirsin.");
            } else if (linkId === 'link-starred-notes') {
                loadStarredNotes();
                showAssistantMessage("√ñnemli olarak i≈üaretlediƒüin yƒ±ldƒ±zlƒ± notlarƒ±n burada listelenir.");
            } else if (linkId === 'link-add-note') {
                loadAddNoteForm();
                showAssistantMessage("Yeni bir not eklemek i√ßin bu formu doldurman yeterli.");
            } else if (linkId === 'link-all-tasks') {
                loadAllTasks();
                showAssistantMessage("T√ºm g√∂revlerin burada. S√ºr√ºkleyip bƒ±rakarak sƒ±ralamayƒ± deƒüi≈ütirebilirsin.");
            } else if (linkId === 'link-starred-tasks') {
                loadStarredTasks();
                showAssistantMessage("Yƒ±ldƒ±zla i≈üaretlediƒüin √∂nemli g√∂revlerin burada.");
            } else if (linkId === 'link-completed-tasks') {
                loadCompletedTasks();
                showAssistantMessage("Ba≈üarƒ±yla tamamladƒ±ƒüƒ±n t√ºm g√∂revleri burada g√∂rebilirsin. Harika i≈ü!");
            } else if (linkId === 'link-upcoming-tasks') {
                loadUpcomingTasks();
                showAssistantMessage("√ñn√ºm√ºzdeki 24 saat i√ßinde vadesi dolacak g√∂revlerini buradan takip et.");
            } else if (linkId === 'link-overdue-tasks') {
                loadOverdueTasks();
                showAssistantMessage("Vadesi ge√ßmi≈ü g√∂revlerin! Bunlarƒ± tamamlamanƒ±n zamanƒ± gelmi≈ü.");
            } else if (linkId === 'link-add-task') {
                loadAddTaskForm();
                showAssistantMessage("Yeni bir g√∂rev olu≈üturmak i√ßin ba≈ülƒ±k ve biti≈ü tarihi ekleyebilirsin.");
            }
        });
    });

    // 2. Dinamik ƒ∞√ßerik Aksiyonlarƒ±
    document.addEventListener("click", async (e) => {
        // YAKALAYICI G√úNCELLENDƒ∞: Eksik olan .delete-note se√ßicisi eklendi.
        const target = e.target.closest(".btn-task-action, .toggle-complete, .delete-task, .delete-note, .edit-note, .edit-task, .toggle-star, .toggle-star-task, #btn-add-note, #btn-add-task, #btn-delete-all-tasks, #btn-delete-all-notes, #btn-cancel-delete, #btn-cancel-edit-note, #btn-cancel-edit-task, #logout-link, #link-settings, #link-badges, #link-avatars, #tags-list-container .nav-link");
        if (!target) return; // Eƒüer tƒ±klanan eleman veya √ºst elemanlarƒ±ndan biri se√ßicilerle e≈üle≈ümiyorsa, devam etme.
        
        const taskId = target.dataset.id;
        const noteId = target.dataset.id;

        // Eƒüer tƒ±klanan link Ayarlar linkiyse
        if (target.id === 'link-settings') {
            e.preventDefault(); // Varsayƒ±lan link davranƒ±≈üƒ±nƒ± durdur
            loadSettingsForm(); // Ayarlar sayfasƒ±nƒ± AJAX ile y√ºkle
            showAssistantMessage("Hesap bilgilerini, ≈üifreni buradan g√ºncelleyebilir veya hesabƒ±nƒ± silebilirsin.");
            // Sidebar linklerinin aktifliƒüini kaldƒ±rmak i√ßin:
            document.querySelectorAll(".nav-link").forEach(link => link.classList.remove("active"));
            return;
        }

        // YENƒ∞: Eƒüer tƒ±klanan link Rozetler linkiyse
        if (target.id === 'link-badges') {
            e.preventDefault();
            loadBadgesPage();
            // Diƒüer sidebar linklerinin aktifliƒüini kaldƒ±r
            document.querySelectorAll(".nav-link").forEach(link => link.classList.remove("active"));
            return; // ƒ∞≈ülemi burada bitir
        }

        // YENƒ∞: Eƒüer tƒ±klanan link Avatarlar linkiyse
        if (target.id === 'link-avatars') {
            e.preventDefault();
            loadAvatarsPage();
            document.querySelectorAll(".nav-link").forEach(link => link.classList.remove("active"));
            return;
        }

        // Eƒüer tƒ±klanan link √ßƒ±kƒ±≈ü linkiyse
        if (target.id === 'logout-link') {
            e.preventDefault(); // Varsayƒ±lan link davranƒ±≈üƒ±nƒ± durdur
        
        // Kullanƒ±cƒ±ya onay sorusu sor
            if (confirm("√áƒ±kƒ±≈ü yapmak istediƒüinizden emin misiniz? T√ºm oturumunuz sonlandƒ±rƒ±lacaktƒ±r.")) {
            // Kullanƒ±cƒ± 'Tamam' derse, √ßƒ±kƒ±≈ü rotasƒ±na y√∂nlendir
                window.location.href = target.href;
            }
        }

        // Not Aksiyonlarƒ±
        if (target.classList.contains("delete-note")) {
             if (confirm("Bu notu silmek istediƒüinizden emin misiniz?")) {
                const res = await fetch(`/dashboard/delete_note/${noteId}`, { method: "DELETE" });
                const result = await res.json();
                showToast(result.message, result.success ? "info" : "danger");
                if (result.success) {
                    currentView === 'starred_notes' ? loadStarredNotes() : loadAllNotes();
                    loadTags(); // Etiket listesini g√ºncelle
                }
            }
        } else if (target.classList.contains("toggle-star")) {
             const res = await fetch(`/dashboard/toggle_star/${noteId}`, { method: "POST" });
             const result = await res.json();
             showToast(result.message, result.success ? "success" : "info");
             if (result.success) {
                currentView === 'starred_notes' ? loadStarredNotes() : loadAllNotes();
             }
        } else if (target.id === "btn-add-note") {
             loadAddNoteForm();
             setActiveLink('link-add-note');
        } 

        // G√∂rev Aksiyonlarƒ±
        else if (target.classList.contains("delete-task") && target.tagName === 'BUTTON') {
             if (confirm("Bu g√∂revi silmek istediƒüinizden emin misiniz?")) {
                const res = await fetch(`/dashboard/delete_task/${taskId}`, { method: "DELETE" });
                const result = await res.json();
                showToast(result.message, result.success ? "info" : "danger");
                if (result.success) {
                    currentView === 'completed_tasks' ? loadCompletedTasks() : loadAllTasks();
                    loadTags(); // Etiket listesini g√ºncelle
                }
            }
        } else if (target.classList.contains("toggle-complete")) {
            const res = await fetch(`/dashboard/toggle_complete/${taskId}`, { method: "POST" });
            const result = await res.json();
            showToast(result.message, result.success ? "success" : "info");
            if (result.success) {
                // YENƒ∞: G√∂rev tamamlandƒ±ƒüƒ±nda konfeti animasyonu
                if (result.completed && typeof confetti === 'function') {
                    const rect = target.getBoundingClientRect();
                    const origin = {
                        x: (rect.left + rect.width / 2) / window.innerWidth,
                        y: (rect.top + rect.height / 2) / window.innerHeight
                    };
                    confetti({
                        origin: origin,
                        particleCount: 100,
                        spread: 70,
                        ticks: 200
                    });
                }
                currentView === 'completed_tasks' ? loadCompletedTasks() : loadAllTasks();
            }
        } else if (target.classList.contains("edit-task")) {
             const taskItem = target.closest(".task-item");
             const taskId = taskItem.dataset.id;
             const task = window.tasks.find(t => t.id == taskId);
             if (task) {
                window.loadEditTaskForm(taskId, encodeURIComponent(task.title), encodeURIComponent(task.content), task.due_date, encodeURIComponent(task.tags.join(', ')));
             }
        } else if (target.classList.contains("toggle-star-task")) {
             const res = await fetch(`/dashboard/toggle_task_star/${taskId}`, { method: "POST" });
             const result = await res.json();
             showToast(result.message, result.success ? "success" : "info");
             if (result.success) {
                currentView === 'completed_tasks' ? loadCompletedTasks() : loadAllTasks();
             }
        } else if (target.id === "btn-add-task") {
             loadAddTaskForm();
             setActiveLink('link-add-task');
        } 
        
        // Hepsini Sil Butonu Aksiyonu (G√ñREVLER)
        else if (target.id === 'btn-delete-all-tasks') {
             if (confirm("UYARI! T√ºm g√∂revleri (tamamlanmƒ±≈ü ve bekleyen) kalƒ±cƒ± olarak silmek istediƒüinizden emin misiniz? Bu i≈ülem geri alƒ±namaz.")) {
                 const res = await fetch("/dashboard/delete_all_tasks", { method: "POST" });
                 const result = await res.json();
                 showToast(result.message, result.success ? "success" : "danger");
                 if (result.success) {
                    loadAllTasks();
                    loadTags(); // Etiket listesini g√ºncelle
                 }
             }
         }
        
        // Hepsini Sil Butonu Aksiyonu (NOTLAR)
        else if (target.id === 'btn-delete-all-notes') {
             if (confirm("UYARI! T√ºm notlarƒ± kalƒ±cƒ± olarak silmek istediƒüinizden emin misiniz?")) {
                 const res = await fetch("/dashboard/delete_all_notes", { method: "POST" });
                 const result = await res.json();
                 showToast(result.message, result.success ? "success" : "danger");
                 if (result.success) {
                    loadAllNotes();
                    loadTags(); // Etiket listesini g√ºncelle
                 }
             }
         }

        // YENƒ∞ AKSƒ∞YON: ƒ∞ptal Butonlarƒ±
        if (target.id === 'btn-cancel-delete') { loadSettingsForm(); return; }
        if (target.id === 'btn-cancel-edit-note') { loadAllNotes(); return; }
        if (target.id === 'btn-cancel-edit-task') { loadAllTasks(); return; }


        // YENƒ∞ AKSƒ∞YON: Etiket linkine tƒ±klama
        if (target.matches('#tags-list-container .nav-link')) {
            e.preventDefault();
            const tagId = target.dataset.tagId;
            const tagName = target.querySelector('.sidebar-text').textContent;
            
            setActiveLink(target.id); // Tƒ±klanan etiketi aktif yap
            currentView = `tag_${tagId}`;
            toggleSearchbar(false);

            const response = await fetch(`/dashboard/get_items_by_tag/${tagId}`);
            const data = await response.json();
            contentArea.innerHTML = createTagItemsHtml(data, tagName);
            showAssistantMessage(`'#${tagName}' etiketine sahip t√ºm not ve g√∂revlerin listeleniyor.`);
        }
    });

    // 3. Form G√∂nderimleri
    document.addEventListener('submit', async function(e) {
        const targetId = e.target.id;
        
        // T√úM formlarƒ± burada y√∂netiyoruz.
        if (['addNoteForm', 'editNoteForm', 'addTaskForm', 'editTaskForm', 'settingsForm', 'changePasswordForm'].includes(targetId)) {
            e.preventDefault();
            
            // Form doƒürulama
            if (!e.target.checkValidity()) {
                e.stopPropagation();
                e.target.classList.add('was-validated');
                showToast('L√ºtfen t√ºm zorunlu alanlarƒ± doldurun.', 'warning');
                return;
            }
            
            // Loading durumunu g√∂ster
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn?.innerHTML || 'Kaydet';
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Kaydediliyor...';
            }
            
            let url = '';
            let isSettings = false;
            let isPasswordChange = false;
            
            if (targetId === 'addNoteForm') url = "/dashboard/add_note";
            else if (targetId === 'editNoteForm') url = `/dashboard/update_note/${e.target.dataset.id}`;
            else if (targetId === 'addTaskForm') url = "/dashboard/add_task";
            else if (targetId === 'editTaskForm') url = `/dashboard/update_task/${e.target.dataset.id}`;
            else if (targetId === 'settingsForm') { url = '/dashboard/update_settings'; isSettings = true; }
            else if (targetId === 'changePasswordForm') { url = '/dashboard/change_password'; isPasswordChange = true; }

            try {
                const formData = new FormData(e.target);
                
                // Eƒüer not formu ise ve se√ßili etiketler varsa ekle
                // 'addNoteForm' i√ßin 'tags' inputunu temizle ve 'selectedTags' dizisini kullan
                if (targetId === 'addNoteForm' || targetId === 'addTaskForm') {
                    formData.delete('tags'); // Formdaki bo≈ü etiketi sil
                    formData.append('tags', selectedTags.join(','));
                } else if (targetId === 'editNoteForm' || targetId === 'editTaskForm') {
                    selectedTags.forEach(tag => formData.append('tags[]', tag));
                }
                
                // CSRF token ekle
                const csrfToken = document.querySelector('[name=csrf_token]')?.value;
                const headers = new Headers();
                if (csrfToken) {
                    headers.append('X-CSRFToken', csrfToken);
                }
                
                const res = await fetch(url, { 
                    method: 'POST',
                    headers: headers,
                    body: formData 
                });
                
                if (!res.ok) {
                    throw new Error('Sunucu yanƒ±t vermedi. L√ºtfen tekrar deneyin.');
                }
                
                const result = await res.json();
                
                // Rozet kontrol√º
                if (result.new_badges && result.new_badges.length > 0) {
                    result.new_badges.forEach(badge => showBadgeToast(badge));
                }

                if (isPasswordChange) {
                    const feedback = document.getElementById("password-feedback");
                    if (feedback) {
                        feedback.innerHTML = `<div class="alert alert-${result.success ? 'success' : 'danger'}">${result.message}</div>`;
                    }
                    if (result.success && result.redirect_logout) {
                        setTimeout(() => window.location.href = "/auth/logout", 1500);
                    }
                } else {
                    showToast(result.message, result.success ? "success" : "danger");
                    if (result.success) {
                        // Ba≈üarƒ±lƒ± i≈ülem sonrasƒ± yenileme
                        if (targetId.includes('Note')) {
                            loadAllNotes();
                            loadTags();
                            // Not formlarƒ±nƒ± sƒ±fƒ±rla
                            if (targetId === 'addNoteForm') {
                                e.target.reset();
                                selectedTags = [];
                                updateSelectedTagsDisplay();
                            }
                        }
                        else if (targetId.includes('Task')) {
                            loadAllTasks();
                            loadTags();
                        }
                        else if (isSettings) { 
                            loadSettingsForm(); 
                        }
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                showToast(error.message || 'Bir hata olu≈ütu', 'error');
            } finally {
                // Loading durumunu kaldƒ±r
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                }
            }
        } else if (e.target.id === 'deleteAccountFormWithPassword') {
            e.preventDefault();
            const formData = new FormData(e.target);
            const feedback = document.getElementById("delete-feedback");
            
            try {
                const res = await fetch('/auth/delete_account_with_password', { 
                    method: 'POST', 
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrf_token]')?.value
                    },
                    body: formData 
                });
                
                if (!res.ok) {
                    throw new Error('Sunucu yanƒ±t vermedi. L√ºtfen tekrar deneyin.');
                }
                
                const result = await res.json();
                
                if (result.success) {
                    if (feedback) {
                        feedback.innerHTML = `<div class="alert alert-success">${result.message}</div>`;
                    }
                    setTimeout(() => { window.location.href = "/auth/account_deleted_page"; }, 1000);
                } else {
                    if (feedback) {
                        feedback.innerHTML = `<div class="alert alert-danger">${result.message}</div>`;
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                if (feedback) {
                    feedback.innerHTML = `<div class="alert alert-danger">ƒ∞≈ülem sƒ±rasƒ±nda bir hata olu≈ütu. L√ºtfen tekrar deneyin.</div>`;
                }
            }
        }
    });
    
    // Arama √ßubuƒüu i√ßin olay dinleyici
    const searchInput = document.getElementById('search-input');
    if (searchInput) {
        searchInput.addEventListener('input', filterContent);
    }

    // YENƒ∞: ƒ∞statistikleri y√ºklemek i√ßin olay dinleyicisini buraya ta≈üƒ±dƒ±k.
    const userIconDropdown = document.querySelector('.user-icon')?.closest('.dropdown');
    if (userIconDropdown) {
        userIconDropdown.addEventListener('show.bs.dropdown', function () {
            // Dropdown a√ßƒ±lmadan hemen √∂nce istatistikleri y√ºkle
            loadUserStats();
        });
    }

    // --- YENƒ∞: Rozet Modalƒ± i√ßin Geli≈ümi≈ü Efektler ---
    const badgeModalEl = document.getElementById('badgeEarnedModal');
    if (badgeModalEl) {
        const mainContent = document.querySelector('.main');
        // Modal g√∂sterildiƒüinde arka planƒ± bulanƒ±kla≈ütƒ±r
        badgeModalEl.addEventListener('show.bs.modal', function () {
            if (mainContent) mainContent.classList.add('content-blur');
        });
        // Modal gizlendiƒüinde bulanƒ±klƒ±ƒüƒ± kaldƒ±r
        badgeModalEl.addEventListener('hide.bs.modal', function () {
            if (mainContent) mainContent.classList.remove('content-blur');
        });
    }

    // --- BA≈ûLANGI√á ƒ∞≈ûLEMLERƒ∞ ---
    loadAllNotes();
    setActiveLink('link-all-notes');
    loadTags(); // Sayfa y√ºklendiƒüinde etiketleri de y√ºkle
    
    // Zamanƒ± yakla≈üan g√∂revleri kontrol et (Hatƒ±rlatƒ±cƒ±)
    function checkUpcomingTasks() {
        fetch("/dashboard/upcoming_tasks")
            .then(res => res.json())
            .then(tasks => {
                if (tasks && tasks.length > 0) {
                    const message = `üîî ${tasks.length} adet yakƒ±n zamanda vadesi dolacak g√∂reviniz var!`;
                    showToast(message, "warning");
                }
            })
            .catch(err => console.error("Hatƒ±rlatma hatasƒ±:", err));
    }

    checkUpcomingTasks();
    setInterval(checkUpcomingTasks, 15 * 60 * 1000); // Her 15 dakikada bir kontrol et


// YENƒ∞ EKLEME: Hesap Silme Onay Formunu y√ºkler
function loadDeleteAccountForm() {
    currentView = "delete_account";
    const contentArea = document.getElementById("mainContent");
    if (!contentArea) return; 

    // ≈ûifre onay formunun HTML'i
    // ƒ∞ptal butonu loadSettingsForm() fonksiyonunu √ßaƒüƒ±rƒ±r.
    contentArea.innerHTML = `
        <div class="card p-4 shadow-lg mx-auto" style="max-width: 400px; margin-top: 50px;">
            <h3 class="text-center mb-4 text-danger">Hesabƒ±nƒ±zƒ± Kapatƒ±n</h3>
            <p class="text-muted text-center">Hesabƒ±nƒ±zƒ± kalƒ±cƒ± olarak kapatmak √ºzeresiniz. Bu i≈ülem geri alƒ±namaz.</p>
            <form id="deleteAccountFormWithPassword">
                <div class="mb-3">
                    <label for="delete_password" class="form-label">Onay ƒ∞√ßin ≈ûifrenizi Girin</label>
                    <input type="password" name="password" id="delete_password" class="form-control" required>
                </div>
                <div id="delete-feedback" class="mt-2 mb-3"></div>
                <div class="d-flex justify-content-end gap-2 mt-4">
                    <button class="btn btn-secondary" type="button" id="btn-cancel-delete">ƒ∞ptal</button>
                    <button class="btn btn-danger" type="submit">Hesabƒ±mƒ± Kalƒ±cƒ± Sil</button>
                </div>
            </form>
        </div>
    `;
}


// loadSettingsForm fonksiyonunu **tam** haliyle g√ºncelle
async function loadSettingsForm() {
    // 1. Durumu ve men√º linkini ayarla
    currentView = "settings";
    setActiveLink('link-settings');
    const contentArea = document.getElementById("mainContent");
    if (!contentArea) return; 

    // 2. Ayarlar sayfasƒ±nƒ±n i√ßeriƒüini sunucudan √ßek ve y√ºkle
    const response = await fetch("/dashboard/settings");
    const html = await response.text();
    contentArea.innerHTML = html;
    
    // 3. YENƒ∞: ≈ûifre Deƒüi≈ütirme Butonu Dinleyicisi
    const changePassBtn = document.getElementById('link-change-password');
    if (changePassBtn) {
        // Bu fonksiyonun (loadChangePasswordForm) tanƒ±mlƒ± olduƒüundan emin olun
        changePassBtn.addEventListener('click', loadChangePasswordForm); 
    }

    // 4. YENƒ∞: Hesap Silme Butonuna aksiyon ekle
    const deleteAccountBtn = document.getElementById('btn-show-delete-form');
    if (deleteAccountBtn) {
        deleteAccountBtn.addEventListener('click', loadDeleteAccountForm);
    }

    // 5. YENƒ∞: Kullanƒ±cƒ± Ayarlarƒ± Formunu dinle (username/email g√ºncelleme)
    const userSettingsForm = document.getElementById('userSettingsForm');
    if (userSettingsForm) {
        userSettingsForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            // update_settings rotasƒ±na AJAX isteƒüi
            const res = await fetch('/dashboard/update_settings', { method: 'POST', body: formData });
            const result = await res.json();
            
            showToast(result.message, result.success ? "success" : "danger");
            // Ba≈üarƒ±lƒ± olursa formu yenile
            if (result.success) loadSettingsForm();
        });
    }
}

    // YENƒ∞: Motivasyon modalƒ±nƒ± g√∂ster
    const welcomeModalElement = document.getElementById('welcomeModal');
    if (welcomeModalElement) {
        const welcomeModal = new bootstrap.Modal(welcomeModalElement);
        welcomeModal.show();
    }

    // --- YENƒ∞: AI Asistanƒ± Mantƒ±ƒüƒ± ---
    const assistantBubble = document.getElementById('assistant-bubble');
    const assistantMessage = document.getElementById('assistant-message');
    let assistantTimeout;

    function showAssistantMessage(message, duration = 5000) {
        if (!assistantBubble || !assistantMessage) return;

        clearTimeout(assistantTimeout); // √ñnceki zamanlayƒ±cƒ±yƒ± temizle
        assistantMessage.textContent = message;
        assistantBubble.classList.add('show');

        assistantTimeout = setTimeout(() => {
            assistantBubble.classList.remove('show');
        }, duration);
    }

    // Sayfa y√ºklendiƒüinde asistanƒ± konu≈ütur
    setTimeout(() => showAssistantMessage("Merhaba! Bug√ºn neler ba≈üaracaƒüƒ±z?"), 2000);


});
