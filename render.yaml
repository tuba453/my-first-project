# render.yaml

services:
  # 1. Web Servisi (Flask Uygulaması)
  - type: web
    name: task-manager-web
    env: python
    plan: free
    buildCommand: "pip install -r requirements.txt"
    startCommand: "gunicorn 'app:app'"
    envVars:
      - key: PYTHON_VERSION
        value: 3.11.0
      - key: SECRET_KEY
        generateValue: true
      - key: DATABASE_URL
        fromService:
          type: psql # HATA DÜZELTİLDİ: 'database' yerine 'psql' kullanılmalı.
          name: task-manager-db
          property: connectionString
      - key: CELERY_BROKER_URL
        fromService:
          type: redis
          name: task-manager-redis
          property: connectionString
      - key: CELERY_RESULT_BACKEND
        fromService:
          type: redis
          name: task-manager-redis
          property: connectionString

  # 2. Arka Plan Çalışanı (Celery Worker)
  - type: worker
    name: task-manager-worker
    env: python
    plan: free
    buildCommand: "pip install -r requirements.txt"
    startCommand: "celery -A app.celery worker --loglevel=info"
    envVars:
      - key: PYTHON_VERSION
        value: 3.11.0
      - key: SECRET_KEY
        fromService:
          type: web
          name: task-manager-web
          envVarKey: SECRET_KEY
      - key: DATABASE_URL
        fromService:
          type: psql # HATA DÜZELTİLDİ: 'database' yerine 'psql' kullanılmalı.
          name: task-manager-db
          property: connectionString
      - key: CELERY_BROKER_URL
        fromService:
          type: redis
          name: task-manager-redis
          property: connectionString
      - key: CELERY_RESULT_BACKEND
        fromService:
          type: redis
          name: task-manager-redis
          property: connectionString
  # 3. Redis Servisi (Celery için)
  - type: redis
    name: task-manager-redis
    plan: free
    ipAllowList: [] # Sadece Render içinden erişime izin verir.
    maxmemoryPolicy: allkeys-lru # Ücretsiz Redis planları için önerilir.

# PostgreSQL veritabanını tanımlamak için kullanılan doğru üst düzey blok
databases:
  - name: task-manager-db
    plan: free